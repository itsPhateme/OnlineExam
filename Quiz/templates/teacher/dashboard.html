{% extends 'base.html' %}
{% load static %}

{% block title %}داشبورد معلم{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
        <h2 class="mb-0 text-primary fw-bold">
            <i class="bi bi-mortarboard-fill me-2"></i>آزمون‌های من
        </h2>
        <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'Quiz:subject_list' %}" class="btn btn-outline-info">
                <i class="bi bi-book me-1"></i> مدیریت دروس
            </a>
            <a href="{% url 'Quiz:create_exam' %}" class="btn btn-success shadow-sm">
                <i class="bi bi-plus-circle-fill me-1"></i> ایجاد آزمون جدید
            </a>
        </div>
    </div>

    {% if exams %}
        <div class="row g-4">
            {% for exam in exams %}
                <div class="col-lg-4 col-md-6">
                    <div class="card h-100 shadow-sm border-0 hover-shadow-lg transition">
                        <div class="card-header bg-gradient text-white
                            {% if exam.has_submitted %}bg-success{% else %}bg-secondary{% endif %}">
                            <h5 class="mb-0">{{ exam.title }}</h5>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <p class="text-muted small mb-mb-2">
                                <i class="bi bi-journal-text"></i> <strong>درس:</strong> {{ exam.subject.name }}
                            </p>
                            <p class="text-muted small mb-2">
                                <i class="bi bi-calendar-event"></i> <strong>شروع:</strong>
                                {{ exam.start_date|date:"d F Y - H:i" }}
                            </p>
                            <p class="text-muted small mb-2">
                                <i class="bi bi-clock"></i> <strong>مدت:</strong> {{ exam.duration_minutes }} دقیقه
                            </p>
                            <p class="text-muted small mb-3">
                                <i class="bi bi-award"></i> <strong>نمره کل:</strong> {{ exam.total_score }}
                            </p>

                            <div class="mt-auto">
                                <div class="btn-group w-100 mb-2" role="group">
                                    <a href="{% url 'Quiz:add_questions' exam.id %}"
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-question-circle"></i> سوالات
                                        <span class="badge bg-primary ms-1">{{ exam.questions.count }}</span>
                                    </a>
                                    <a href="{% url 'Quiz:edit_exam' exam.id %}"
                                       class="btn btn-outline-warning btn-sm">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                    <a href="{% url 'Quiz:delete_exam' exam.id %}"
                                       class="btn btn-outline-danger btn-sm"
                                       onclick="return confirm('مطمئنید می‌خواهید این آزمون را حذف کنید؟')">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </div>

                                <!-- لینک هوشمند تصحیح -->
                              <!-- لینک هوشمند تصحیح — کاملاً ایمن و بدون خطا -->
                                                        {% if exam.single_submission and exam.first_submission %}
                                <a href="{% url 'Quiz:grade_student_answers' exam.first_submission.id %}" class="btn btn-success w-100">
                                    تصحیح پاسخ (۱ نفر)
                                </a>
                            {% elif exam.has_submitted %}
                                <a href="{% url 'Quiz:grade_exam' exam.id %}" class="btn btn-success w-100">
                                    تصحیح آزمون ({{ exam.submitted_count }} نفر)
                                </a>
                            {% else %}
                                <button class="btn btn-secondary w-100" disabled>در انتظار پاسخ</button>
                            {% endif %}
                            </div>
                        </div>
                        <div class="card-footer text-center text-muted small">
                            <i class="bi bi-calendar-check"></i>
                            ایجاد شده در: {{ exam.created_at|date:"d M Y" }}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- حالت خالی بودن آزمون -->
        <div class="text-center py-5 my-5">
            <i class="bi bi-inbox display-1 text-muted opacity-50"></i>
            <h3 class="mt-4 text-muted">هنوز آزمونی ایجاد نکرده‌اید</h3>
            <p class="text-muted mb-4">برای شروع، یک درس بسازید یا مستقیماً آزمون جدید ایجاد کنید.</p>
            <div class="d-flex justify-content-center gap-3 flex-wrap">
                <a href="{% url 'Quiz:subject_list' %}" class="btn btn-outline-info btn-lg px-4">
                    <i class="bi bi-book"></i> مدیریت دروس
                </a>
                <a href="{% url 'Quiz:create_exam' %}" class="btn btn-success btn-lg px-5 shadow">
                    <i class="bi bi-plus-circle"></i> ایجاد اولین آزمون
                </a>
            </div>
        </div>
    {% endif %}
</div>

<style>
    .hover-shadow-lg {
        transition: all 0.3s ease;
    }
    .hover-shadow-lg:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15) !important;
    }
    .bg-gradient {
        background: linear-gradient(135deg, #0d6efd, #0dcaf0);
    }
</style>
{% endblock %}